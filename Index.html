<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jerry-mall</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #bfac99; /* 整個頁面的背景色 */
        }
        header {
            background-color: #a3896f; /* 改為和按鈕一樣的顏色 */
            color: white;
            text-align: center;
            padding: 10px 0;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f0f0f0; /* 將容器背景也改為淺灰色 */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        form, select, textarea, button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #a3896f; /* 淺藍色 */
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #8a7259; /* 稍深一點的藍色，用於懸停效果 */
        }
        .product {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .product img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin-right: 20px;
            border-radius: 8px;
        }
        .error, .success {
            margin-top: 10px;
            color: red;
            font-size: 14px;
        }
        .pagination, #merchantPagination {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        .pagination button, #merchantPagination button {
            margin: 0 2px;
            padding: 0;
            font-size: 72px; /* 將字體大小增加到 72px */
            background-color: #a3896f;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            width: 80px; /* 調整寬度以適應更大的字體 */
            height: 80px; /* 調整高度以適應更大的字體 */
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: unset; /* 移除最小寬度限制 */
            line-height: normal; /* 恢復正常行高 */
        }
        .pagination button:disabled, #merchantPagination button:disabled {
            background-color: #8a7259;
            color: white;
            cursor: default;
        }
        .pagination button:hover:not(:disabled), #merchantPagination button:hover:not(:disabled) {
            background-color: #b99d7f;
        }
        .order-list {
            margin-top: 20px;
        }
        .product-actions {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        .product-actions select {
            width: auto;
            margin-right: 10px;
        }
        .product-actions button {
            width: auto;
        }
        #viewOrdersBtn {
            display: none;
            margin-top: 20px;
        }
        .order-details {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .order-item {
            margin-bottom: 5px;
        }

        /* 新增的樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #f0f0f0; /* 模態框背景也改為淺灰色 */
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #merchantBtn {
            display: none; /* 初始隱藏 */
            margin-top: 20px;
        }

        /* 新增樣式，確保表單和其他元素有更好的可讀性 */
        form, .product, .order-details {
            background-color: #ffffff; /* 表單和產品卡片使用白色背景 */
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* 調整商家功能中的表單背景 */
        #merchantProductForm {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        #productForm {
            display: none; /* 初始隱藏新增商品表單 */
        }

        #merchantPagination {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        #merchantPagination button {
            margin: 0 1px;
            padding: 1px;
            font-size: 12px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 2px;
            cursor: pointer;
            min-width: 16px;
            height: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #merchantPagination button:disabled {
            background-color: #a3896f;
            color: white;
            cursor: default;
        }

        #merchantPagination button:hover:not(:disabled) {
            background-color: #b99d7f;
        }

        /* 調整分頁按鈕樣式 */
        .pagination button, #merchantPagination button {
            margin: 0 1px;
            padding: 2px 4px;
            font-size: 8px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 2px;
            cursor: pointer;
            min-width: 16px;
            height: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination button:disabled, #merchantPagination button:disabled {
            background-color: #a3896f;
            color: white;
            cursor: default;
        }

        .pagination button:hover:not(:disabled), #merchantPagination button:hover:not(:disabled) {
            background-color: #b99d7f;
        }

        /* 移除搜索部分的放大樣式 */
        #searchKeyword, #searchButton, #categoryFilter {
            font-size: inherit;
            padding: 10px;
            height: auto;
        }
    </style>
</head>
<body>
    <header>
        <h1>Jerry-mall</h1>
    </header>

    <div class="container">
        <p id="activateMessage" style="color: #a3896f; font-weight: bold; margin-bottom: 10px; text-align: center;">
            因後端API架設於免費平台，請先按下啟動鍵後，稍待1~2分鐘，待跳出啟動成功視窗後，方可正常進行註冊登入，謝謝
        </p>
        <button id="activateBtn" style="margin-bottom: 20px;">啟動</button>

        <!-- 註冊表單 -->
        <form id="registerForm">
            <h2>註冊</h2>
            <input type="email" id="registerEmail" placeholder="電子郵件" required>
            <input type="password" id="registerPassword" placeholder="密碼" required>
            <button type="submit">註冊</button>
            <div class="success" id="registerSuccess"></div>
            <div class="error" id="registerError"></div>
        </form>

        <!-- 登入表單 -->
        <form id="loginForm">
            <h2>登入</h2>
            <input type="email" id="loginEmail" placeholder="電子郵件" required>
            <input type="password" id="loginPassword" placeholder="密碼" required>
            <button type="submit">登入</button>
            <div class="success" id="loginSuccess"></div>
            <div class="error" id="loginError"></div>
        </form>

        <!-- 搜索表單 -->
        <div id="searchForm" style="display: none;">
            <select id="categoryFilter">
                <option value="">所有類別</option>
                <option value="BOOK">書籍</option>
                <option value="CAR">汽車</option>
                <option value="FOOD">食品</option>
            </select>
            <input type="text" id="searchKeyword" placeholder="搜索商品">
            <button id="searchButton">搜索</button>
        </div>

        <!-- 購物車區域 -->
        <div id="cartIcon" style="position: fixed; top: 10px; right: 10px; cursor: pointer;">
            <img src="https://img.lovepik.com/free-png/20210918/lovepik-shopping-cart-png-image_400179806_wh300.png" alt="購物車" style="width: 50px; height: 50px;">
            <span id="cartItemCount" style="position: absolute; top: -5px; right: -5px; background-color: red; color: white; border-radius: 50%; padding: 2px 5px; font-size: 12px;">0</span>
        </div>

        <div id="cartSection" style="display: none; position: fixed; top: 70px; right: 10px; background-color: white; border: 1px solid #ddd; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); max-width: 300px; z-index: 1000;">
            <h2>購物車</h2>
            <div id="cartList"></div>
            <div id="cartTotal" style="font-weight: bold; margin-top: 10px;"></div>
            <button onclick="placeOrder()">下單</button>
        </div>

        <!-- 查看訂單按鈕 (初始隱藏) -->
        <button id="viewOrdersBtn" style="display: none;">查看我的訂單</button>

        <!-- 訂單列表 -->
        <div class="order-list" id="orderList"></div>

        <!-- 商品列表 -->
        <div class="product-list" id="productList"></div>

        <!-- 分頁 -->
        <div class="pagination" id="pagination"></div>

        <!-- 商家功能按鈕 -->
        <button id="merchantBtn" style="display: none;">商家功能</button>
    </div>

    <!-- 商家功能模態框 -->
    <div id="merchantModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>商家功能</h2>
            <button id="addNewProductBtn">新增商品</button>
            <div id="merchantProductList"></div>
            <div id="merchantPagination"></div>
        </div>
    </div>

    <!-- 新增商品模態框 -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>新增商品</h2>
            <form id="addProductForm">
                <input type="text" id="newProductName" placeholder="商品名稱" required>
                <select id="newProductCategory" required>
                    <option value="" disabled selected>選擇類別</option>
                    <option value="BOOK">書籍</option>
                    <option value="CAR">汽車</option>
                    <option value="FOOD">食品</option>
                </select>
                <input type="text" id="newProductImageUrl" placeholder="圖片網址" required>
                <input type="number" id="newProductPrice" placeholder="價格" required>
                <input type="number" id="newProductStock" placeholder="庫存" required>
                <textarea id="newProductDescription" placeholder="描述"></textarea>
                <button type="submit">新增商品</button>
            </form>
        </div>
    </div>

    <!-- 編輯商品模態框 -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>編輯商品</h2>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <input type="text" id="editProductName" placeholder="商品名稱" required>
                <select id="editProductCategory" required>
                    <option value="" disabled selected>選擇類別</option>
                    <option value="BOOK">書籍</option>
                    <option value="CAR">汽車</option>
                    <option value="FOOD">食品</option>
                </select>
                <input type="text" id="editProductImageUrl" placeholder="圖片網址" required>
                <input type="number" id="editProductPrice" placeholder="價格" required>
                <input type="number" id="editProductStock" placeholder="庫存" required>
                <textarea id="editProductDescription" placeholder="描述"></textarea>
                <button type="submit">更新商品</button>
            </form>
        </div>
    </div>

    <!-- 在 <body> 標籤內，添加會員資訊圖標和彈出框 -->
    <div id="memberIcon" style="position: fixed; top: 10px; right: 70px; cursor: pointer;">
        <img src="https://img.88icon.com/download/jpg/20200901/3e9ce3813b7199ea9588eeb920f41208_512_512.jpg!bg" alt="會員資訊" style="width: 50px; height: 50px;">
    </div>

    <div id="memberInfoSection" style="display: none; position: fixed; top: 70px; right: 70px; background-color: white; border: 1px solid #ddd; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); max-width: 300px; z-index: 1000;">
        <h2>會員資訊</h2>
        <div id="memberInfo"></div>
        <button id="logoutBtn" style="margin-top: 10px; width: 100%;">登出</button>
    </div>

    <script>
        let currentPage = 1;
        const pageSize = 5;
        let currentUser = null;
        let totalProducts = 0;

        // 啟動按鈕
        document.getElementById('activateBtn').addEventListener('click', () => {
            fetch('https://springboot-mall-2.onrender.com/activate')
                .then(response => response.text())
                .then(data => {
                    alert(data); // 顯示後端返回的消息
                })
                .catch(error => {
                    console.error('Activation error:', error);
                    alert('啟動失敗，請稍後再試');
                });
        });

        // 註冊功能
        document.getElementById('registerForm').addEventListener('submit', (event) => {
            event.preventDefault();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();

            fetch('https://springboot-mall-2.onrender.com/User/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 400) {
                        throw new Error('該email已經被註冊');
                    } else {
                        throw new Error('註冊失敗，請稍後再試');
                    }
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('registerSuccess').textContent = '註冊成功';
                document.getElementById('registerError').textContent = '';
                document.getElementById('registerForm').reset();
            })
            .catch(error => {
                console.error('Registration error:', error);
                document.getElementById('registerError').textContent = error.message;
                document.getElementById('registerSuccess').textContent = '';
            });
        });

        // 登入功能
        document.getElementById('loginForm').addEventListener('submit', (event) => {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            fetch('https://springboot-mall-2.onrender.com/User/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 400) {
                        throw new Error('帳號或密碼錯誤');
                    } else {
                        throw new Error('登入失敗，請稍後再試');
                    }
                }
                return response.json();
            })
            .then(data => {
                saveUserToLocalStorage(data); // 保存用戶信息到 localStorage
                setLoggedInState(data);
            })
            .catch(error => {
                console.error('Login error:', error);
                document.getElementById('loginError').textContent = error.message;
                document.getElementById('loginSuccess').textContent = '';
            });
        });

        // 添加價格格式化函數
        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // 修改 fetchProducts 函數
        function fetchProducts(category = '', search = '') {
            const url = new URL('https://springboot-mall-2.onrender.com/products');
            url.searchParams.append('limit', pageSize);
            url.searchParams.append('offset', (currentPage - 1) * pageSize);
            if (category) url.searchParams.append('category', category);
            if (search) url.searchParams.append('search', search);

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const productList = document.getElementById('productList');
                    productList.innerHTML = '';
                    data.results.forEach(product => {
                        const productDiv = document.createElement('div');
                        productDiv.className = 'product';
                        productDiv.innerHTML = `
                            <img src="${product.imageUrl}" alt="${product.productName}">
                            <div>
                                <h3>${product.productName}</h3>
                                <p>類別: ${product.category}</p>
                                <p>價格: $${formatPrice(product.price)}</p>
                                <p>庫存: ${product.stock}</p>
                                <p>描述: ${product.description}</p>
                                ${currentUser ? `
                                    <div class="product-actions">
                                        <select id="quantity-${product.productId}">
                                            ${Array.from({length: 10}, (_, i) => i + 1).map(num => `<option value="${num}">${num}</option>`).join('')}
                                        </select>
                                        <button onclick="addToCart(${product.productId}, parseInt(document.getElementById('quantity-${product.productId}').value))">加入購物車</button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        productList.appendChild(productDiv);
                    });

                    totalProducts = data.total;
                    updatePagination();
                });
        }

        // 新增更新分頁函數
        function updatePagination() {
            const totalPages = Math.ceil(totalProducts / pageSize);
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                if (
                    i === 1 ||
                    i === totalPages ||
                    (i >= currentPage - 1 && i <= currentPage + 1)
                ) {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = i;
                    pageButton.addEventListener('click', () => {
                        currentPage = i;
                        fetchProducts();
                    });
                    if (i === currentPage) {
                        pageButton.disabled = true;
                    }
                    paginationDiv.appendChild(pageButton);
                } else if (
                    i === currentPage - 2 ||
                    i === currentPage + 2
                ) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.margin = '0 2px';
                    paginationDiv.appendChild(ellipsis);
                }
            }
        }

        // 初始化時隱藏商品列表
        document.getElementById('productList').style.display = 'none';

        // 添加 addToOrder 函數
        function addToOrder(productId, quantity) {
            const orderData = {
                buyItemList: [{
                    productId: parseInt(productId),
                    quantity: parseInt(quantity)
                }]
            };

            fetch(`https://springboot-mall-2.onrender.com/order/${currentUser.userId}/orders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            })
            .then(response => {
                if (!response.ok) throw new Error('加入購物車失敗');
                return response.json();
            })
            .then(data => {
                alert('已成功加入購物車');
            })
            .catch(error => {
                alert('加入購物車失敗: ' + error.message);
            });
        }

        // 查看訂單按鈕點擊事件
        document.getElementById('viewOrdersBtn').addEventListener('click', () => {
            const orderList = document.getElementById('orderList');
            if (currentUser) {
                if (orderList.style.display === 'none' || orderList.innerHTML === '') {
                    fetchUserOrders(currentUser.userId);
                    orderList.style.display = 'block';
                    document.getElementById('viewOrdersBtn').textContent = '隱藏我的訂單';
                } else {
                    orderList.style.display = 'none';
                    document.getElementById('viewOrdersBtn').textContent = '查看我的訂單';
                }
            } else {
                alert('請先登入');
            }
        });

        // 修改取得使用者訂單函數
        function fetchUserOrders(userId) {
            fetch(`https://springboot-mall-2.onrender.com/user/${userId}/orders?limit=10&offset=0`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('取得訂單失敗');
                    }
                    return response.json();
                })
                .then(data => {
                    const orderList = document.getElementById('orderList');
                    orderList.innerHTML = '<h2>我的訂單</h2>';
                    if (data.results.length === 0) {
                        orderList.innerHTML += '<p>您目前沒有任何訂單</p>';
                    } else {
                        data.results.forEach(order => {
                            const orderDiv = document.createElement('div');
                            orderDiv.className = 'order';
                            orderDiv.innerHTML = `
                                <p>訂單ID: ${order.orderId}</p>
                                <p>訂單總金額: $${formatPrice(order.totalAmount)}</p>
                                <p>下單時間: ${new Date(order.createdDate).toLocaleString()}</p>
                                <button onclick="toggleOrderDetails(${order.orderId})">顯示訂單明細</button>
                                <div id="orderDetails-${order.orderId}" class="order-details" style="display: none;">
                                    <h3>訂單明細</h3>
                                    ${order.orderItemsList.map(item => `
                                        <div class="order-item">
                                            <img src="${item.imageUrl}" alt="${item.productName}" style="width: 50px; height: 50px; object-fit: cover;">
                                            <p>商品名稱: ${item.productName}</p>
                                            <p>數量: ${item.quantity}</p>
                                            <p>小計: $${formatPrice(item.amount)}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                            orderList.appendChild(orderDiv);
                        });
                    }
                    orderList.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching orders:', error);
                    alert('取得訂單失敗: ' + error.message);
                });
        }

        // 顯示/隱藏訂單明細
        function toggleOrderDetails(orderId) {
            const detailsDiv = document.getElementById(`orderDetails-${orderId}`);
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
        }

        // 添加商家功能按鈕的事件監聽器
        document.getElementById('merchantBtn').addEventListener('click', () => {
            document.getElementById('merchantModal').style.display = 'block';
            fetchMerchantProducts();
        });

        let merchantCurrentPage = 1;
        const merchantPageSize = 5;
        let merchantTotalProducts = 0;

        // 修改獲取商家商品列表函數
        function fetchMerchantProducts() {
            fetch(`https://springboot-mall-2.onrender.com/products?limit=${merchantPageSize}&offset=${(merchantCurrentPage - 1) * merchantPageSize}`)
                .then(response => response.json())
                .then(data => {
                    const merchantProductList = document.getElementById('merchantProductList');
                    merchantProductList.innerHTML = '<h3>商品列表</h3>';
                    data.results.forEach(product => {
                        const productDiv = document.createElement('div');
                        productDiv.innerHTML = `
                            <p>${product.productName} - $${product.price}</p>
                            <button onclick="editProduct(${product.productId})">編輯</button>
                            <button onclick="deleteProduct(${product.productId})">刪除</button>
                        `;
                        merchantProductList.appendChild(productDiv);
                    });
                    merchantTotalProducts = data.total;
                    updateMerchantPagination();
                })
                .catch(error => console.error('Error fetching merchant products:', error));
        }

        // 添加商家商品列表分頁函數
        function updateMerchantPagination() {
            const totalPages = Math.ceil(merchantTotalProducts / merchantPageSize);
            const paginationDiv = document.getElementById('merchantPagination');
            paginationDiv.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                if (
                    i === 1 ||
                    i === totalPages ||
                    (i >= merchantCurrentPage - 1 && i <= merchantCurrentPage + 1)
                ) {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = i;
                    pageButton.addEventListener('click', () => {
                        merchantCurrentPage = i;
                        fetchMerchantProducts();
                    });
                    if (i === merchantCurrentPage) {
                        pageButton.disabled = true;
                    }
                    paginationDiv.appendChild(pageButton);
                } else if (
                    i === merchantCurrentPage - 2 ||
                    i === merchantCurrentPage + 2
                ) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.margin = '0 2px';
                    paginationDiv.appendChild(ellipsis);
                }
            }
        }

        // 修改編輯商品函數
        function editProduct(productId) {
            fetch(`https://springboot-mall-2.onrender.com/products/${productId}`)
                .then(response => response.json())
                .then(product => {
                    document.getElementById('editProductId').value = product.productId;
                    document.getElementById('editProductName').value = product.productName;
                    document.getElementById('editProductCategory').value = product.category;
                    document.getElementById('editProductImageUrl').value = product.imageUrl;
                    document.getElementById('editProductPrice').value = product.price;
                    document.getElementById('editProductStock').value = product.stock;
                    document.getElementById('editProductDescription').value = product.description;
                    document.getElementById('editProductModal').style.display = 'block';
                })
                .catch(error => console.error('Error fetching product details:', error));
        }

        // 修改處理編輯商品表單提交
        document.getElementById('editProductForm').addEventListener('submit', (event) => {
            event.preventDefault();
            const productId = document.getElementById('editProductId').value;
            const productData = {
                productName: document.getElementById('editProductName').value.trim(),
                category: document.getElementById('editProductCategory').value,
                imageUrl: document.getElementById('editProductImageUrl').value.trim(),
                price: parseInt(document.getElementById('editProductPrice').value),
                stock: parseInt(document.getElementById('editProductStock').value),
                description: document.getElementById('editProductDescription').value.trim()
            };

            console.log('Updating product data:', productData); // 添加這行來記錄發送的數據

            fetch(`https://springboot-mall-2.onrender.com/products/${productId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(productData)
            })
            .then(response => {
                if (!response.ok) throw new Error('更新商品失敗');
                return response.json();
            })
            .then(data => {
                alert('商品已成功更新');
                document.getElementById('editProductModal').style.display = 'none';
                fetchMerchantProducts();
            })
            .catch(error => {
                console.error('Error updating product:', error);
                alert('更新商品失敗: ' + error.message);
            });
        });

        // 刪除商品
        function deleteProduct(productId) {
            if (confirm('確定要刪除這個商品嗎？')) {
                fetch(`https://springboot-mall-2.onrender.com/products/${productId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('商品已成功刪除');
                        fetchMerchantProducts();
                    } else {
                        throw new Error('刪除商品失敗');
                    }
                })
                .catch(error => console.error('Error deleting product:', error));
            }
        }

        // 添加關閉商家功能模態框的邏輯
        document.querySelector('.close').addEventListener('click', () => {
            document.getElementById('merchantModal').style.display = 'none';
        });

        // 點擊模態框外部時關閉
        window.addEventListener('click', (event) => {
            if (event.target == document.getElementById('merchantModal')) {
                document.getElementById('merchantModal').style.display = 'none';
            }
        });

        // 添加新增商品按鈕的事件監聽器
        document.getElementById('addNewProductBtn').addEventListener('click', () => {
            document.getElementById('addProductModal').style.display = 'block';
        });

        // 處理新增商品表單提交
        document.getElementById('addProductForm').addEventListener('submit', (event) => {
            event.preventDefault();
            const productData = {
                productName: document.getElementById('newProductName').value.trim(),
                category: document.getElementById('newProductCategory').value,
                imageUrl: document.getElementById('newProductImageUrl').value.trim(),
                price: parseInt(document.getElementById('newProductPrice').value),
                stock: parseInt(document.getElementById('newProductStock').value),
                description: document.getElementById('newProductDescription').value.trim()
            };

            console.log('Sending product data:', productData); // 添加這行來記錄發送的數據

            fetch('https://springboot-mall-2.onrender.com/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(productData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        try {
                            // 嘗試解析錯誤響應為 JSON
                            const errorJson = JSON.parse(text);
                            throw new Error(errorJson.message || '新增商品失敗');
                        } catch (e) {
                            // 如果不是 JSON，則使用原始文本
                            throw new Error(text || '新增商品失敗');
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('新增商品成功:', data);
                alert('商品已成功新增');
                document.getElementById('addProductForm').reset();
                document.getElementById('addProductModal').style.display = 'none';
                fetchMerchantProducts();
            })
            .catch(error => {
                console.error('Error adding new product:', error);
                alert('新增商品失敗: ' + error.message);
            });
        });

        // 添加關閉新增商品模態框的邏輯
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', () => {
                closeBtn.closest('.modal').style.display = 'none';
            });
        });

        // 點擊模態框外部時關閉
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // 添加搜索功能
        document.getElementById('searchButton').addEventListener('click', () => {
            const category = document.getElementById('categoryFilter').value;
            const search = document.getElementById('searchKeyword').value;
            currentPage = 1; // 重置頁碼
            fetchProducts(category, search);
        });

        // 在 script 標籤內添加以下代碼

        let cart = [];

        function addToCart(productId, quantity) {
            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({ productId, quantity });
            }
            updateCartDisplay();
            updateCartItemCount();
            alert('成功加入購物車!');
        }

        function updateCartDisplay() {
            const cartList = document.getElementById('cartList');
            cartList.innerHTML = '';
            let totalAmount = 0;
            
            const promises = cart.map(item => 
                fetch(`https://springboot-mall-2.onrender.com/products/${item.productId}`)
                    .then(response => response.json())
                    .then(product => {
                        const cartItem = document.createElement('div');
                        cartItem.innerHTML = `
                            <img src="${product.imageUrl}" alt="${product.productName}" style="width: 50px; height: 50px; object-fit: cover;">
                            <p>商品名稱: ${product.productName}, 數量: ${item.quantity}, 單價: $${formatPrice(product.price)}</p>
                            <button onclick="removeFromCart(${item.productId})">移除</button>
                        `;
                        cartList.appendChild(cartItem);
                        totalAmount += product.price * item.quantity;
                        return totalAmount;
                    })
            );

            Promise.all(promises).then(() => {
                document.getElementById('cartTotal').textContent = `總金額: $${formatPrice(totalAmount)}`;
            });
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.productId !== productId);
            updateCartDisplay();
            updateCartItemCount();
        }

        function placeOrder() {
            if (cart.length === 0) {
                alert('購物車是空的');
                return;
            }
            
            const orderData = {
                buyItemList: cart.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity
                }))
            };

            fetch(`https://springboot-mall-2.onrender.com/order/${currentUser.userId}/orders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            })
            .then(response => {
                if (!response.ok) throw new Error('下單失敗');
                return response.json();
            })
            .then(data => {
                alert('訂單已成功建立');
                cart = [];
                updateCartDisplay();
                fetchUserOrders(currentUser.userId);
            })
            .catch(error => {
                alert('下單失敗: ' + error.message);
            });
        }

        // 更新購物車圖標的商品數量
        function updateCartItemCount() {
            const count = cart.reduce((total, item) => total + item.quantity, 0);
            document.getElementById('cartItemCount').textContent = count;
        }

        // 添加購物車圖標的點擊事件
        document.getElementById('cartIcon').addEventListener('click', () => {
            const cartSection = document.getElementById('cartSection');
            cartSection.style.display = cartSection.style.display === 'none' ? 'block' : 'none';
        });

        // 在頁面加載完成後初始化購物車圖標
        window.addEventListener('load', () => {
            updateCartItemCount();
        });

        // 添加會員圖標的點擊事件
        document.getElementById('memberIcon').addEventListener('click', () => {
            const memberInfoSection = document.getElementById('memberInfoSection');
            if (memberInfoSection.style.display === 'none') {
                if (currentUser) {
                    updateMemberInfo();
                } else {
                    document.getElementById('memberInfo').innerHTML = '<p>請先登入</p>';
                }
                memberInfoSection.style.display = 'block';
            } else {
                memberInfoSection.style.display = 'none';
            }
        });

        // 更新會員信息
        function updateMemberInfo() {
            const memberInfo = document.getElementById('memberInfo');
            let createdDateString = '未知';
            if (currentUser.createdDate) {
                // 假設後端返回的是一個毫秒級的時間戳
                const createdDate = new Date(currentUser.createdDate);
                if (!isNaN(createdDate.getTime())) {
                    createdDateString = createdDate.toLocaleDateString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                }
            }
            memberInfo.innerHTML = `
                <p>電子郵件: ${currentUser.email}</p>
                <p>用戶ID: ${currentUser.userId}</p>
                <p>創建時間: ${createdDateString}</p>
            `;
        }

        // 在 <script> 標籤內添加以下函數

        // 保存用戶信息到 localStorage
        function saveUserToLocalStorage(user) {
            localStorage.setItem('currentUser', JSON.stringify(user));
        }

        // 從 localStorage 獲取用戶信息
        function getUserFromLocalStorage() {
            const userStr = localStorage.getItem('currentUser');
            return userStr ? JSON.parse(userStr) : null;
        }

        // 清除 localStorage 中的用戶信息
        function clearUserFromLocalStorage() {
            localStorage.removeItem('currentUser');
        }

        // 設置用戶登錄狀態
        function setLoggedInState(user) {
            currentUser = user;
            document.getElementById('loginSuccess').textContent = '登入成功';
            document.getElementById('loginError').textContent = '';
            document.getElementById('viewOrdersBtn').style.display = 'block';
            document.getElementById('merchantBtn').style.display = 'block';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('productList').style.display = 'block';
            document.getElementById('activateBtn').style.display = 'none';
            document.getElementById('searchForm').style.display = 'block';
            document.getElementById('cartSection').style.display = 'block';
            document.getElementById('activateMessage').style.display = 'none';
            updateMemberInfo();
            fetchProducts();
        }

        // 在頁面加載時檢查登錄狀態
        window.addEventListener('load', () => {
            const savedUser = getUserFromLocalStorage();
            if (savedUser) {
                setLoggedInState(savedUser);
            }
            updateCartItemCount();
        });

        // 添加登出功能
        function logout() {
            clearUserFromLocalStorage();
            currentUser = null;
            // 重置UI到未登錄狀態
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('viewOrdersBtn').style.display = 'none';
            document.getElementById('merchantBtn').style.display = 'none';
            document.getElementById('productList').style.display = 'none';
            document.getElementById('searchForm').style.display = 'none';
            document.getElementById('cartSection').style.display = 'none';
            document.getElementById('activateBtn').style.display = 'block';
            document.getElementById('activateMessage').style.display = 'block';
            cart = [];
            updateCartItemCount();
        }

        // 添加登出按鈕的事件監聽器
        document.getElementById('logoutBtn').addEventListener('click', logout);
    </script>
</body>
</html>